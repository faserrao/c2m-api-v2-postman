#!/bin/bash
# =============================================================================
# GitHub Actions Compatibility Test
# =============================================================================
# Purpose: Validate that the pipeline works correctly in GitHub Actions
# Author: Generated by Claude
# Date: September 27, 2025
# =============================================================================

set -uo pipefail

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Test tracking
PASSED=0
FAILED=0
WARNINGS=0

# Helper functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_pass() {
    echo -e "${GREEN}[PASS]${NC} $1"
    ((PASSED++))
}

log_fail() {
    echo -e "${RED}[FAIL]${NC} $1"
    ((FAILED++))
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    ((WARNINGS++))
}

log_section() {
    echo ""
    echo -e "${BLUE}===================================================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}===================================================================${NC}"
}

# =============================================================================
# WORKFLOW FILE TESTS
# =============================================================================

test_workflow_files() {
    log_section "Testing Workflow Files"
    
    # Check main workflow
    if [ -f ".github/workflows/api-ci-cd.yml" ]; then
        log_pass "Main CI/CD workflow exists"
        
        # Validate YAML syntax
        if yq eval '.' .github/workflows/api-ci-cd.yml &>/dev/null; then
            log_pass "api-ci-cd.yml has valid YAML syntax"
        else
            log_fail "api-ci-cd.yml has invalid YAML syntax"
        fi
        
        # Check for required jobs
        local jobs=$(yq eval '.jobs | keys' .github/workflows/api-ci-cd.yml 2>/dev/null)
        if [[ "$jobs" == *"build"* ]]; then
            log_pass "Build job found in workflow"
        else
            log_fail "Build job missing from workflow"
        fi
    else
        log_fail "Main CI/CD workflow missing"
    fi
    
    # Check PR drift check workflow
    if [ -f ".github/workflows/pr-drift-check.yml" ]; then
        log_pass "PR drift check workflow exists"
    else
        log_warn "PR drift check workflow missing (optional)"
    fi
}

# =============================================================================
# CI TARGET TESTS
# =============================================================================

test_ci_targets() {
    log_section "Testing CI-Specific Makefile Targets"
    
    # Required CI targets
    local ci_targets=(
        "openapi-build"
        "postman-collection-build"
        "docs"
        "lint"
        "diff"
    )
    
    for target in "${ci_targets[@]}"; do
        if grep -q "^${target}:" Makefile; then
            log_pass "CI target exists: $target"
            
            # Test dry run
            if make -n "$target" &>/dev/null; then
                log_info "  - Target $target validates correctly"
            else
                log_warn "  - Target $target has potential issues"
            fi
        else
            log_fail "CI target missing: $target"
        fi
    done
}

# =============================================================================
# DEPENDENCY TESTS
# =============================================================================

test_dependencies() {
    log_section "Testing CI Dependencies"
    
    # Check for requirements files
    if [ -f "requirements.txt" ] || [ -f "scripts/python_env/requirements.txt" ]; then
        log_pass "Python requirements file exists"
    else
        log_warn "No Python requirements file found"
    fi
    
    if [ -f "package.json" ]; then
        log_pass "package.json exists"
        
        # Check for lock file
        if [ -f "package-lock.json" ]; then
            log_pass "package-lock.json exists (deterministic builds)"
        else
            log_warn "package-lock.json missing (non-deterministic builds)"
        fi
    else
        log_fail "package.json missing"
    fi
}

# =============================================================================
# ENVIRONMENT SIMULATION
# =============================================================================

test_ci_environment() {
    log_section "Testing CI Environment Simulation"
    
    # Test with minimal environment (simulate CI)
    log_info "Simulating CI environment variables..."
    
    # Save current env
    local saved_home=$HOME
    local saved_user=$USER
    
    # Simulate CI environment
    export CI=true
    export GITHUB_ACTIONS=true
    export GITHUB_WORKSPACE=$(pwd)
    export RUNNER_OS=Linux
    
    # Test OpenAPI generation in CI mode
    log_info "Testing OpenAPI generation in CI environment..."
    if make openapi-build &>/dev/null; then
        log_pass "OpenAPI generation works in CI environment"
    else
        log_fail "OpenAPI generation fails in CI environment"
    fi
    
    # Restore environment
    export CI=
    export GITHUB_ACTIONS=
    export HOME=$saved_home
    export USER=$saved_user
}

# =============================================================================
# SECRET REQUIREMENTS
# =============================================================================

test_secret_requirements() {
    log_section "Testing Secret Requirements"
    
    # Parse workflow for required secrets
    log_info "Checking required secrets in workflow..."
    
    if [ -f ".github/workflows/api-ci-cd.yml" ]; then
        # Extract secrets from workflow
        local secrets=$(grep -oE '\$\{\{\s*secrets\.[A-Z_]+\s*\}\}' .github/workflows/api-ci-cd.yml | 
                       sed 's/${{[[:space:]]*secrets\.//' | sed 's/[[:space:]]*}}//' | sort -u)
        
        if [ -n "$secrets" ]; then
            echo "Required secrets:"
            while IFS= read -r secret; do
                echo "  - $secret"
                
                # Check if it's documented
                if grep -q "$secret" README.md 2>/dev/null || grep -q "$secret" .github/workflows/README.md 2>/dev/null; then
                    log_pass "Secret documented: $secret"
                else
                    log_warn "Secret not documented: $secret"
                fi
            done <<< "$secrets"
        else
            log_info "No secrets found in workflow"
        fi
    fi
}

# =============================================================================
# PATH AND PERMISSION TESTS
# =============================================================================

test_paths_permissions() {
    log_section "Testing Paths and Permissions"
    
    # Check if scripts are executable
    local scripts=(
        "scripts/active/add_tests.js"
        "scripts/active/validate_collection.js"
    )
    
    for script in "${scripts[@]}"; do
        if [ -f "$script" ]; then
            if [ -r "$script" ]; then
                log_pass "Script readable: $script"
            else
                log_fail "Script not readable: $script"
            fi
        else
            log_warn "Script not found: $script"
        fi
    done
}

# =============================================================================
# POSTMAN CLI TESTS
# =============================================================================

test_postman_cli() {
    log_section "Testing Postman CLI Requirements"
    
    # Check if workflow installs Postman CLI
    if grep -q "dl-cli.pstmn.io" .github/workflows/api-ci-cd.yml; then
        log_pass "Workflow installs Postman CLI"
    else
        log_fail "Workflow doesn't install Postman CLI"
    fi
    
    # Check if Postman login is handled
    if grep -q "postman-login" Makefile; then
        log_pass "Postman login target exists"
    else
        log_fail "Postman login target missing"
    fi
}

# =============================================================================
# OUTPUT AND ARTIFACT TESTS
# =============================================================================

test_artifacts() {
    log_section "Testing Artifact Configuration"
    
    # Check if workflow uploads artifacts
    if grep -q "actions/upload-artifact" .github/workflows/api-ci-cd.yml 2>/dev/null; then
        log_pass "Workflow uploads artifacts"
    else
        log_warn "Workflow doesn't upload artifacts"
    fi
    
    # Check if workflow handles GitHub Pages
    if grep -q "actions/deploy-pages" .github/workflows/api-ci-cd.yml 2>/dev/null; then
        log_pass "Workflow deploys to GitHub Pages"
    else
        log_info "GitHub Pages deployment not configured"
    fi
}

# =============================================================================
# BRANCH PROTECTION TESTS
# =============================================================================

test_branch_protection() {
    log_section "Testing Branch Protection Compatibility"
    
    # Check if PR workflow exists
    if [ -f ".github/workflows/pr-drift-check.yml" ]; then
        log_pass "PR drift check workflow exists"
        
        # Check if it runs on PRs
        if grep -q "pull_request:" .github/workflows/pr-drift-check.yml; then
            log_pass "Drift check runs on pull requests"
        else
            log_fail "Drift check doesn't run on pull requests"
        fi
    else
        log_info "No PR drift check workflow"
    fi
}

# =============================================================================
# SUMMARY REPORT
# =============================================================================

generate_report() {
    log_section "GitHub Actions Test Summary"
    
    local total=$((PASSED + FAILED))
    echo "Total tests: $total"
    echo -e "Passed: ${GREEN}$PASSED${NC}"
    echo -e "Failed: ${RED}$FAILED${NC}"
    echo -e "Warnings: ${YELLOW}$WARNINGS${NC}"
    
    echo ""
    if [ $FAILED -eq 0 ]; then
        echo -e "${GREEN}âœ… GitHub Actions compatibility confirmed!${NC}"
        
        if [ $WARNINGS -gt 0 ]; then
            echo -e "${YELLOW}âš ï¸  Some warnings should be reviewed${NC}"
        fi
        
        echo ""
        echo "Next steps:"
        echo "1. Ensure all required secrets are configured in GitHub"
        echo "2. Test the workflow with: git push origin feature/test-ci"
        echo "3. Monitor the Actions tab in GitHub"
        
        return 0
    else
        echo -e "${RED}âŒ GitHub Actions compatibility issues found${NC}"
        echo ""
        echo "Fix the failed tests before pushing to GitHub"
        return 1
    fi
}

# =============================================================================
# DRY RUN TEST
# =============================================================================

test_dry_run() {
    log_section "Testing CI Targets (Dry Run)"
    
    # Test the main CI sequence
    log_info "Testing CI build sequence..."
    
    local targets=(
        "openapi-build"
        "postman-collection-build"
        "docs"
    )
    
    for target in "${targets[@]}"; do
        echo -e "\n${BLUE}Testing:${NC} make $target (dry run)"
        if make -n "$target" 2>&1 | head -20; then
            log_pass "Dry run successful: $target"
        else
            log_fail "Dry run failed: $target"
        fi
    done
}

# =============================================================================
# MAIN EXECUTION
# =============================================================================

main() {
    echo "ðŸš€ GitHub Actions Compatibility Test"
    echo "ðŸ“… $(date)"
    echo ""
    
    test_workflow_files
    test_ci_targets
    test_dependencies
    test_ci_environment
    test_secret_requirements
    test_paths_permissions
    test_postman_cli
    test_artifacts
    test_branch_protection
    
    # Optional dry run
    if [ "${1:-}" = "--dry-run" ]; then
        test_dry_run
    fi
    
    generate_report
}

# Run with optional dry run
main "$@"